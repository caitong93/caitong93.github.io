<!DOCTYPE html>
<html class="no-js" lang="en-US">
    <head>
        <meta charset="utf-8">

        

        <base href="https://caitong93.github.io">
        <title>Code Notes</title>
        <link rel="canonical" href="https://caitong93.github.io/posts/">
        <link href="https://caitong93.github.io/posts/index.xml" rel="alternate" type="application/rss+xml" title="Code Notes"/>

        
<link rel="stylesheet" href="css/styles.css">


<link href='http://fonts.googleapis.com/css?family=Roboto+Slab' rel='stylesheet' type='text/css'>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.3.0/contrib/auto-render.min.js"></script>

    </head>
    <body>
        <div class="column">


<header class="header">
    <a href="/" class="title">Code Notes</a>
    
</header>


<section id="main">
    <div>
        
            <article class="post">
    <header class="post-summary-header">
      <p class="post-title"><a href="https://caitong93.github.io/posts/envoy-hot-restart-implementation-analysis/">Envoy Hot Restart Implementation Analysis </a></p>
      <p class="post-meta">Mar 23 2021 - 5 min </p>
    </header>

    Introduction Envoy 热重启功能的目的是为了减少 Envoy 重启/升级所需的 downtime。当一个新的 Envoy 进程启动时如果有在运行的 Envoy 进程，新的 Envoy 就会执行热重启逻辑。 热重启的实现主要依赖 SHM(Linux Shared Memory), UDS(Unix Domain Socket) 和 Protobuf。SHM 存储了热重启的基本状态，和用于进程间同步的锁。Envoy 启动后会首先检测 SHM 中的状态，如果存在错误则立即退出。UDS 用于 child 和 server 之间的通信，消息以 Protobuf 格式序列化，消息类型包括从 parent 获取 listen sockets, 从 parent 获取 stats。 Envoy 热重启会保证 listen sockets 和 stats 在进程间无中断转移，而 parent 上已经建立的连接是会断开的。如果 7 层协议具有优雅断开机制，则流量无损。如果像是 tcp_proxy 这样的连接则是可能有损流量的。
SHM struct SharedMemory 是 SHM 对应的数据结构，size_ 是结构体大小, version_ 为热重启协议版本，只有版本相等进程之间才能进行热重启。log_lock 和 access_log_lock 用于控制进程间日志操作的同步，这里可以先忽略。flags_ 存储状态标志，目前只有 SHMEM_FLAGS_INITIALIZING，表示 Envoy 是否处于初始化阶段。
// Increment this whenever there is a shared memory / RPC change that will prevent a hot restart // from working.
    <footer>
        <a href='https://caitong93.github.io/posts/envoy-hot-restart-implementation-analysis/'><nobr>more →</nobr></a>
    </footer>
</article>

        
    </div>
</section>

<footer class="bottom-footer">
  <div class="copyright">
    <p>
    
    <a href="http://creativecommons.org/licenses/by/4.0/" title="Creative Commons Attribution">Some rights reserved</a>; 
    please attribute properly and link back.
    
    
    </p>
  </div>
</footer>

<script>
    renderMathInElement(document.getElementById('main'));
</script>

</div>
</body>
</html>

